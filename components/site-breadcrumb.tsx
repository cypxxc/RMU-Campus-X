"use client"

import { useContext } from "react"
import Link from "next/link"
import { usePathname } from "next/navigation"
import { Home } from "lucide-react"

import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from "@/components/ui/breadcrumb"
import { NavigationHistoryContext } from "@/components/navigation-history-provider"
import { pathToHistoryEntries } from "@/lib/breadcrumb-labels"

export function SiteBreadcrumb() {
  const pathname = usePathname()
  const ctx = useContext(NavigationHistoryContext)

  if (pathname === "/") return null

  const history = ctx?.history ?? (pathname ? pathToHistoryEntries(pathname) : [])
  const navigateToBreadcrumb = ctx?.navigateToBreadcrumb

  if (history.length <= 1) return null

  return (
    <div className="w-full bg-background">
      <div className="container py-2">
        <Breadcrumb>
          <BreadcrumbList>
            {history.map((entry, index) => {
              const isLast = index === history.length - 1
              const isFirst = index === 0

              return (
                <div key={`${entry.path}-${index}`} className="flex items-center gap-1.5 sm:gap-2.5">
                  {index > 0 && <BreadcrumbSeparator />}
                  <BreadcrumbItem>
                    {isLast ? (
                      <BreadcrumbPage>{entry.label}</BreadcrumbPage>
                    ) : navigateToBreadcrumb ? (
                      <BreadcrumbLink asChild>
                        <button
                          type="button"
                          onClick={() => navigateToBreadcrumb(index)}
                          className="flex items-center gap-1 bg-transparent border-0 cursor-pointer p-0 text-inherit font-inherit hover:text-foreground transition-colors"
                        >
                          {isFirst && <Home className="h-4 w-4" />}
                          <span className={isFirst ? "hidden sm:inline" : ""}>{entry.label}</span>
                        </button>
                      </BreadcrumbLink>
                    ) : (
                      <BreadcrumbLink asChild>
                        <Link href={entry.path} className="flex items-center gap-1">
                          {isFirst && <Home className="h-4 w-4" />}
                          <span className={isFirst ? "hidden sm:inline" : ""}>{entry.label}</span>
                        </Link>
                      </BreadcrumbLink>
                    )}
                  </BreadcrumbItem>
                </div>
              )
            })}
          </BreadcrumbList>
        </Breadcrumb>
      </div>
    </div>
  )
}
