rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // ðŸ›¡ï¸ SECURITY UTILITIES
    // ============================================================================

    // Basic Authentication Check
    function isAuthenticated() {
      return request.auth != null;
    }

    // Strict Ownership Check (document ID matches auth UID)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Admin Check via Database Lookup
    // Admin documents are manually created - no client can write to admins collection
    function isAdmin() {
      return isAuthenticated() 
          && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // RMU Email Domain Check (Student ID format: 12 digits @rmu.ac.th)
    function hasRMUEmail() {
      return isAuthenticated() 
          && request.auth.token.email != null
          && request.auth.token.email.matches('^[0-9]{12}@rmu[.]ac[.]th$');
    }

    // Verified Email Check
    function isVerifiedEmail() {
      return isAuthenticated() && request.auth.token.email_verified == true;
    }

    // Active User Status Check
    // Reads user profile to check if not banned/suspended
    function isActiveUser() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null 
          && userDoc.data.status in ['ACTIVE', 'WARNING'];
    }

    // Combined Eligibility Check for RMU Students
    // Must be: authenticated + verified email + RMU domain + active status
    function isEligibleStudent() {
      return isAuthenticated()
          && isVerifiedEmail()
          && hasRMUEmail()
          && isActiveUser();
    }

    // Helper: Check if specific keys are NOT being modified
    function notUpdating(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }

    // Helper: Check if ONLY specific keys are being modified
    function onlyUpdating(fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }

    // ============================================================================
    // ðŸ“‚ COLLECTION RULES
    // ============================================================================

    // ----------------------------------------------------------------------------
    // ðŸ‘¤ USERS COLLECTION
    // Public read for displaying user info on posts/comments
    // Create: Only own document with strict validation
    // Update: Only safe fields, no privilege escalation
    // ----------------------------------------------------------------------------
    match /users/{userId} {
      // Public read - needed for displaying poster info
      allow read: if true;

      // Validation: User profile data
      function isValidUserData(data) {
        return (data.displayName == null || 
                (data.displayName is string && data.displayName.size() >= 1 && data.displayName.size() <= 50))
            && (data.photoURL == null || 
                (data.photoURL is string && data.photoURL.size() < 2000))
            && (data.bio == null || 
                (data.bio is string && data.bio.size() <= 300));
      }

      // CREATE: Register new user
      // - Must be owner of the UID
      // - Must have RMU email
      // - Cannot overwrite existing document
      // - Cannot set privileged fields
      allow create: if isOwner(userId)
                    && hasRMUEmail()
                    && !exists(/databases/$(database)/documents/users/$(userId))
                    // Email must match authenticated email
                    && request.resource.data.email == request.auth.token.email
                    // Cannot set admin flag
                    && request.resource.data.get('isAdmin', false) == false
                    // Must start as ACTIVE
                    && request.resource.data.get('status', 'ACTIVE') == 'ACTIVE'
                    // Cannot manipulate warning count
                    && request.resource.data.get('warningCount', 0) == 0
                    // Data validation
                    && isValidUserData(request.resource.data);

      // UPDATE: Profile updates
      // - Only owner can update
      // - Cannot change immutable/privileged fields
      allow update: if isOwner(userId)
                    && notUpdating(['email', 'uid', 'isAdmin', 'status', 'warningCount', 
                                    'createdAt', 'bannedReason', 'suspendedUntil'])
                    && isValidUserData(request.resource.data);

      // ADMIN: Full access for admin operations
      allow write: if isAdmin();
    }

    // ----------------------------------------------------------------------------
    // ðŸ“¦ ITEMS COLLECTION
    // Public read for browsing
    // Create/Update: Only eligible students with validation
    // ----------------------------------------------------------------------------
    match /items/{itemId} {
      // Public read - item listings visible to all authenticated users
      allow read: if true;

      // Validation: Item data
      function isValidItemData(data) {
        return data.title is string && data.title.size() >= 1 && data.title.size() <= 100
            && data.description is string && data.description.size() <= 2000
            && data.category in ['electronics', 'books', 'furniture', 'clothing', 'sports', 'other']
            && data.status in ['available', 'pending', 'completed']
            && (data.location == null || (data.location is string && data.location.size() <= 100))
            && (data.imageUrls == null || (data.imageUrls is list && data.imageUrls.size() <= 5));
      }

      // CREATE: Post new item
      allow create: if isEligibleStudent()
                    && request.resource.data.postedBy == request.auth.uid
                    && request.resource.data.postedByEmail == request.auth.token.email
                    && request.resource.data.status == 'available'
                    && request.resource.data.postedAt == request.time
                    && isValidItemData(request.resource.data);

      // UPDATE: Edit item
      allow update: if isAuthenticated() && (
                      // Owner can update (except immutable fields)
                      (resource.data.postedBy == request.auth.uid 
                       && notUpdating(['postedBy', 'postedByEmail', 'postedAt'])
                       && isValidItemData(request.resource.data))
                      // Admin can update anything
                      || isAdmin()
                      // Active users can update only status (for exchange flow)
                      || (isActiveUser() 
                          && onlyUpdating(['status', 'updatedAt'])
                          && request.resource.data.status in ['available', 'pending', 'completed'])
                    );

      // DELETE: Only owner or admin
      allow delete: if (isAuthenticated() && resource.data.postedBy == request.auth.uid) 
                    || isAdmin();
    }

    // ----------------------------------------------------------------------------
    // ðŸ¤ EXCHANGES COLLECTION
    // Private transaction flow between two parties
    // ----------------------------------------------------------------------------
    match /exchanges/{exchangeId} {
      // Participant check for existing documents
      function isParticipant() {
        return resource.data.requesterId == request.auth.uid 
            || resource.data.ownerId == request.auth.uid;
      }

      // Valid exchange status transitions
      function isValidStatusTransition(oldStatus, newStatus) {
        return (oldStatus == 'pending' && newStatus in ['accepted', 'rejected', 'cancelled'])
            || (oldStatus == 'accepted' && newStatus in ['in_progress', 'cancelled'])
            || (oldStatus == 'in_progress' && newStatus in ['completed', 'cancelled']);
      }

      // READ: Only participants or admin
      allow read: if isAuthenticated() && (isParticipant() || isAdmin());

      // LIST: With query protection
      allow list: if isAuthenticated() && request.query.limit <= 50;

      // CREATE: Eligible student initiates exchange
      allow create: if isEligibleStudent()
                    && request.resource.data.requesterId == request.auth.uid
                    && request.resource.data.requesterEmail == request.auth.token.email
                    && request.resource.data.status == 'pending'
                    && request.resource.data.createdAt == request.time;

      // UPDATE: Participants or admin
      allow update: if isAuthenticated() && (
                      (isParticipant() && isActiveUser()
                       && notUpdating(['requesterId', 'requesterEmail', 'ownerId', 'ownerEmail', 
                                       'itemId', 'itemTitle', 'createdAt']))
                      || isAdmin()
                    );

      // DELETE: Admin only (cleanup)
      allow delete: if isAdmin();
    }

    // ----------------------------------------------------------------------------
    // ðŸ’¬ CHAT MESSAGES COLLECTION
    // Private messaging between exchange participants
    // ----------------------------------------------------------------------------
    match /chatMessages/{messageId} {
      // Check if user is participant in the related exchange
      function isMessageParticipant() {
        let exchange = get(/databases/$(database)/documents/exchanges/$(resource.data.exchangeId));
        return exchange != null && (
          exchange.data.requesterId == request.auth.uid 
          || exchange.data.ownerId == request.auth.uid
        );
      }

      // Check for new message creation
      function canSendMessage() {
        let exchange = get(/databases/$(database)/documents/exchanges/$(request.resource.data.exchangeId));
        return exchange != null && (
          exchange.data.requesterId == request.auth.uid 
          || exchange.data.ownerId == request.auth.uid
        );
      }

      // READ: Only exchange participants or admin
      allow read: if isAuthenticated() && (isMessageParticipant() || isAdmin());

      // CREATE: Participants can send messages
      allow create: if isAuthenticated() 
                    && isActiveUser()
                    && request.resource.data.senderId == request.auth.uid
                    && request.resource.data.senderEmail == request.auth.token.email
                    && request.resource.data.createdAt == request.time
                    && canSendMessage();

      // Messages are immutable - no updates
      allow update: if false;

      // DELETE: Admin only
      allow delete: if isAdmin();
    }

    // ----------------------------------------------------------------------------
    // ðŸŽ« REPORTS COLLECTION
    // Students can create reports, only admin can manage
    // ----------------------------------------------------------------------------
    match /reports/{reportId} {
      // READ: Reporter can read own, admin can read all
      allow read: if isAuthenticated() && (
                    resource.data.reporterId == request.auth.uid || isAdmin()
                  );

      // CREATE: Eligible student can submit report
      allow create: if isEligibleStudent()
                    && request.resource.data.reporterId == request.auth.uid
                    && request.resource.data.reporterEmail == request.auth.token.email
                    && request.resource.data.status == 'new'
                    && request.resource.data.createdAt == request.time
                    && request.resource.data.reportType in ['item_report', 'exchange_report', 'chat_report', 'user_report'];

      // UPDATE: Admin only
      allow update: if isAdmin();

      // DELETE: Admin only
      allow delete: if isAdmin();
    }

    // ----------------------------------------------------------------------------
    // ðŸŽ« SUPPORT TICKETS COLLECTION
    // ----------------------------------------------------------------------------
    match /support_tickets/{ticketId} {
      // READ: Owner or admin
      allow read: if isAuthenticated() && (
                    resource.data.userId == request.auth.uid || isAdmin()
                  );

      // CREATE: Authenticated user
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.userEmail == request.auth.token.email
                    && request.resource.data.status == 'new';

      // UPDATE: User can only add messages, admin can update anything
      allow update: if isAdmin() 
                    || (resource.data.userId == request.auth.uid 
                        && notUpdating(['status', 'priority', 'repliedBy', 'repliedByEmail', 
                                        'repliedAt', 'adminReply', 'resolvedAt', 'userId', 'userEmail']));

      // DELETE: Admin only
      allow delete: if isAdmin();
    }

    // ----------------------------------------------------------------------------
    // ðŸ”” NOTIFICATIONS COLLECTION
    // Private to notification owner
    // ----------------------------------------------------------------------------
    match /notifications/{notificationId} {
      // READ: Owner only
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // CREATE: Only for yourself (self-notifications)
      // Cross-user notifications use Admin SDK
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;

      // UPDATE: Owner can mark as read
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && onlyUpdating(['isRead']);

      // DELETE: Owner can delete own notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ----------------------------------------------------------------------------
    // â­ REVIEWS COLLECTION
    // Public read, reviewer can create, no edits
    // ----------------------------------------------------------------------------
    match /reviews/{reviewId} {
      allow read: if true;

      allow create: if isEligibleStudent()
                    && request.resource.data.reviewerId == request.auth.uid
                    && request.resource.data.createdAt == request.time;

      // Reviews are immutable
      allow update: if false;

      allow delete: if isAdmin();
    }

    // ----------------------------------------------------------------------------
    // â¤ï¸ FAVORITES COLLECTION
    // Private to owner
    // ----------------------------------------------------------------------------
    match /favorites/{favoriteId} {
      // favoriteId format: {userId}_{itemId}
      // READ: Owner only
      allow read: if isAuthenticated() && (
                    favoriteId.split('_')[0] == request.auth.uid 
                    || (resource != null && resource.data.userId == request.auth.uid)
                  );

      // CREATE: Owner only
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;

      // DELETE: Owner only
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // No updates - just create/delete
      allow update: if false;
    }

    // ----------------------------------------------------------------------------
    // ðŸ“ DRAFTS COLLECTION
    // Private to owner
    // ----------------------------------------------------------------------------
    match /drafts/{draftId} {
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;

      allow read, update, delete: if isAuthenticated() 
                                  && resource.data.userId == request.auth.uid;
    }

    // ----------------------------------------------------------------------------
    // ðŸ‘® ADMIN & SYSTEM COLLECTIONS
    // Highly restricted access
    // ----------------------------------------------------------------------------

    // ADMINS: Read own status, no client writes
    match /admins/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false; // Manual setup via Firebase Console only
    }

    // ADMIN LOGS: Admin read only, writes via Admin SDK
    match /adminLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // USER WARNINGS: Owner/Admin read, writes via Admin SDK
    match /userWarnings/{warningId} {
      allow read: if isAuthenticated() && (
                    resource.data.userId == request.auth.uid || isAdmin()
                  );
      allow write: if false;
    }

    // CASES: Admin panel data
    match /cases/{caseId} {
      allow read, write: if isAdmin();
    }

    // ----------------------------------------------------------------------------
    // ðŸš« DEFAULT DENY
    // Catch-all rule - explicitly deny everything else
    // ----------------------------------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
